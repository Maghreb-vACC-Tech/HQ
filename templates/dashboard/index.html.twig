{% extends 'base.html.twig' %}

{% block title %}Hello DashboardController!{% endblock %}

{% block link %}  {% endblock %}

{% block body %}


<style>
    .example-wrapper > div{
        display: inline-block;
        margin-left: 7vw;
        margin-top: 5vh;
    }
    .Controllers-Online{
        width:40vw;
        height:50vh;
        background-color: #D8D8D8;    
        margin:auto;
        border-radius:5px;
    }
    .Controllers-Online-Title{
        width:35vw;
        margin:auto;
        height:7vh;

    }
    .Controllers-Online-Title > div{
        width:11.6vw;
        height:7vh;
        float:left;
        text-align:center;
        padding-top:1vh;
        border-bottom: 1px solid white;
    }
    .Controllers-Online-Content{
        width:35vw;
        height:7vh;
        border-bottom: 1px solid white;
        margin:auto;
        margin-top:1vh;
    }
    .Controllers-Online-Content > div{
        width:11.6vw;
        height:7vh;
        margin:auto;
        float:left;
        text-align:center;
        padding-top:1vh;
        }
</style>

<div class="example-wrapper">


    <div class="Controllers-Online">

        <h1 style="font-size:3vh;text-align:center;padding:2vh">Online Controllers</h1>

        <div class="Controllers-Online-Title">
            <div><p>Position</p></div>
            <div><p>Name</p></div>
            <div><p>CID</p></div>
        </div>

        <div style="width:35vw;height:40vh;overflow-y:auto;margin:auto">
            <div class="Controllers-Online-Content">
                <div class="Controllers-Online-Content-Position"><p>GMMN_TWR</p></div>
                <div class="Controllers-Online-Content-Name"><p>Ilyass</p></div>
                <div class="Controllers-Online-Content-CID"><p>1674212</p></div>
            </div>

            <div class="Controllers-Online-Content">
                <div class="Controllers-Online-Content-Position"><p>GMMN_TWR</p></div>
                <div class="Controllers-Online-Content-Name"><p>Ilyass</p></div>
                <div class="Controllers-Online-Content-CID"><p>1674212</p></div>
            </div>

            <div class="Controllers-Online-Content">
                <div class="Controllers-Online-Content-Position"><p>GMMN_TWR</p></div>
                <div class="Controllers-Online-Content-Name"><p>Ilyass</p></div>
                <div class="Controllers-Online-Content-CID"><p>1674212</p></div>
            </div>
        </div>
        
    </div>
    
    
    <div class="Controllers-Online">

        <h1 style="font-size:3vh;text-align:center;padding:2vh">Todays Bookings</h1>

        <div class="Controllers-Online-Title">
            <div><p>Position</p></div>
            <div><p>Name</p></div>
            <div><p>CID</p></div>
        </div>

        <div style="width:35vw;height:40vh;overflow-y:auto;margin:auto">
            <div class="Controllers-Online-Content">
                <div class="Controllers-Online-Content-Position"><p>GMMN_TWR</p></div>
                <div class="Controllers-Online-Content-Name"><p>Ilyass</p></div>
                <div class="Controllers-Online-Content-CID"><p>1674212</p></div>
            </div>

            <div class="Controllers-Online-Content">
                <div class="Controllers-Online-Content-Position"><p>GMMN_TWR</p></div>
                <div class="Controllers-Online-Content-Name"><p>Ilyass</p></div>
                <div class="Controllers-Online-Content-CID"><p>1674212</p></div>
            </div>

            <div class="Controllers-Online-Content">
                <div class="Controllers-Online-Content-Position"><p>GMMN_TWR</p></div>
                <div class="Controllers-Online-Content-Name"><p>Ilyass</p></div>
                <div class="Controllers-Online-Content-CID"><p>1674212</p></div>
            </div>
        </div>
        
    </div>

</div>
{# ATC ACTIVITY SCRIPT #}
{% block scripts %}
    <script>
                
        let previousCallsigns = [];
        console.log('Ready!');
                
        setInterval(() => {
    try {
      fetch('https://data.vatsim.net/v3/vatsim-data.json', { timeout: 30000 })
        .then(data => data.json())
        .then(response => {
          const filteredResponse = response.controllers.filter(item =>
            /^(DAAA|DAAD|DAAE|DAAG|DAAJ|DAAK|DAAP|DAAS|DAAT|DAAV|DABB|DABC|DABS|DABT|DAOB|DAOF|DAOI|DAOL|DAON|DAOO|DAOR|DAOV|DAOY|DATG|DATM|DAUA|DAUB|DAUE|DAUG|DAUH|DAUI|DAUK|DAUO|DAUT|DAUU|DAUZ|DTTC|DTKA|DTMB|DTNH|DTTA|DTTB|DTTF|DTTG|DTTI|DTTJ|DTTX|DTTZ|GMMM|GMAC|GMAD|GMAG|GMAT|GMAZ|GMFB|GMFF|GMFI|GMFK|GMFM|GMFO|GMFZ|GMMA|GMMB|GMMD|GMME|GMMH|GMMI|GMML|GMMN|GMMT|GMMW|GMMX|GMMZ|GMTA|GMTN|GMTT)/.test(item.callsign)
          )
          const currentCallsigns = filteredResponse.map(item => ({
            callsigned: item.callsign,
            cid: item.cid,
            time: item.logon_time,
            frequency: item.frequency,
            user: item.name
          }));

          const onlineCallsigns = currentCallsigns.filter(current => !previousCallsigns.some(prev => prev.callsigned === current.callsigned && prev.cid === current.cid));
          const offlineCallsigns = previousCallsigns.filter(prev => !currentCallsigns.some(current => current.callsigned === prev.callsigned && current.cid === prev.cid));

          offlineCallsigns.forEach(callsign => {
            console.log(callsign.callsigned)
            console.log(callsign.user)
            console.log(callsign.cid)
          });
          onlineCallsigns.forEach(callsign => {
            // Check if the frequency is equal to "199.998"
            if (callsign.frequency === "199.998") {
              // Set up an event listener to detect changes in the frequency
              const checkFrequency = setInterval(() => {
                fetch('https://data.vatsim.net/v3/vatsim-data.json')
                  .then(response => response.json())
                  .then(data => {
                    const filteredResponse = data.clients.filter(client => client.frequency === callsign.frequency && client.callsign === callsign.callsigned);
                    if (filteredResponse.length > 0) {
                      // The frequency has changed, so send the Discord message and clear the event listener
                        console.log(callsign.callsigned)
                        console.log(callsign.user)
                        console.log(callsign.cid)
                    }
                  })
                  .catch(error => {
                    console.error(error);
                  });
              }, 10000);
            } else {
              // The frequency is already set, so send the Discord message immediately
                console.log(callsign.callsigned)
                console.log(callsign.user)
                console.log(callsign.cid)
            }
          });

          previousCallsigns = currentCallsigns;
        })
        .catch(error => {
          console.error(error);
        });
    } catch (error) {
      console.error(error);
    }
  }, 10000);



    </script>
{% endblock %}


{% endblock %}

